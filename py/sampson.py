# Computes first order derivative (gradient) of the sampson distance (MASKS page 388, formula 11.12)
# fvec={f1, f2, f4, f5, a1, b1, a2, b2}
# for derivation, see Ch11_SampsDist.nb
def SampsonDistanceMultPrime(fvec, xs1, xs2, fvec_prime):
    f1, f2, f4, f5, a1, b1, a2, b2 = fvec
    for x1,x2 in zip(xs1,xs2):
        x11,x12,x13 = x1
        x21,x22,x23 = x2

        f1_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) + \
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))* \
  (-((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)* \
       (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)* \
       (x22 + b2*x23))*(2*(x11 + a1*x13)*(f1*(x11 + a1*x13) + \
        f4*(x12 + b1*x13)) + 2*(x21 + a2*x23)*(f1*(x21 + a2*x23) + \
        f2*(x22 + b2*x23)))) + 2*(x11 + a1*x13)*(x21 + a2*x23)* \
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2))) / \
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        f2_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) + \
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))* \
  (-((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)* \
       (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)* \
       (x22 + b2*x23))*(2*(x11 + a1*x13)*(f2*(x11 + a1*x13) +  \
        f5*(x12 + b1*x13)) + 2*(x22 + b2*x23)*(f1*(x21 + a2*x23) + \
        f2*(x22 + b2*x23)))) + 2*(x11 + a1*x13)*(x22 + b2*x23)* \
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 +  \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/ \
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 +  \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        f4_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) + \
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))* \
  (-((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)* \
       (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)* \
       (x22 + b2*x23))*(2*(x12 + b1*x13)*(f1*(x11 + a1*x13) + \
        f4*(x12 + b1*x13)) + 2*(x21 + a2*x23)*(f4*(x21 + a2*x23) + \
        f5*(x22 + b2*x23)))) + 2*(x12 + b1*x13)*(x21 + a2*x23)* \
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/ \
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        f5_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) +\
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))*\
  (-((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*\
       (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*\
       (x22 + b2*x23))*(2*(x12 + b1*x13)*(f2*(x11 + a1*x13) + \
        f5*(x12 + b1*x13)) + 2*(x22 + b2*x23)*(f4*(x21 + a2*x23) +\
        f5*(x22 + b2*x23)))) + 2*(x12 + b1*x13)*(x22 + b2*x23)*\
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/\
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        a1_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) +\
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))*\
  (-2*x13*(f1**2*(x11 + a1*x13) + f1*f4*(x12 + b1*x13) + \
     f2*(f2*(x11 + a1*x13) + f5*(x12 + b1*x13)))*\
    (f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*\
      (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*\
      (x22 + b2*x23)) + 2*x13*(f1*(x21 + a2*x23) + f2*(x22 + b2*x23))*\
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/\
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        b1_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) +\
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))*\
  (-2*x13*(f1*f4*(x11 + a1*x13) + f2*f5*(x11 + a1*x13) + \
     (f4**2 + f5**2)*(x12 + b1*x13))*(f1*(x11 + a1*x13)*(x21 + a2*x23) +\
     f4*(x12 + b1*x13)*(x21 + a2*x23) + \
     (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23)) +\
   2*x13*(f4*(x21 + a2*x23) + f5*(x22 + b2*x23))*\
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/\
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        a2_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) +\
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))*\
  (-2*x23*(f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*\
      (x21 + a2*x23) + (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*\
      (x22 + b2*x23))*(f1**2*(x21 + a2*x23) + f1*f2*(x22 + b2*x23) +\
     f4*(f4*(x21 + a2*x23) + f5*(x22 + b2*x23))) + \
   2*(f1*(x11 + a1*x13) + f4*(x12 + b1*x13))*x23*\
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/\
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        b2_prime = ((f1*(x11 + a1*x13)*(x21 + a2*x23) + f4*(x12 + b1*x13)*(x21 + a2*x23) +\
   (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23))*\
  (-2*x23*(f1*f2*(x21 + a2*x23) + f4*f5*(x21 + a2*x23) + \
     (f2**2 + f5**2)*(x22 + b2*x23))*(f1*(x11 + a1*x13)*(x21 + a2*x23) +\
     f4*(x12 + b1*x13)*(x21 + a2*x23) + \
     (f2*x11 + f5*x12 + a1*f2*x13 + b1*f5*x13)*(x22 + b2*x23)) +\
   2*(f2*(x11 + a1*x13) + f5*(x12 + b1*x13))*x23*\
    ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
     (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
     (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
     (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)))/\
 ((f1*(x11 + a1*x13) + f4*(x12 + b1*x13))**2 + \
   (f2*(x11 + a1*x13) + f5*(x12 + b1*x13))**2 + \
   (f1*(x21 + a2*x23) + f2*(x22 + b2*x23))**2 + \
   (f4*(x21 + a2*x23) + f5*(x22 + b2*x23))**2)**2

        fvec_prime[0] += f1_prime
        fvec_prime[1] += f2_prime
        fvec_prime[2] += f4_prime
        fvec_prime[3] += f5_prime
        fvec_prime[4] += a1_prime
        fvec_prime[5] += b1_prime
        fvec_prime[6] += a2_prime
        fvec_prime[7] += b2_prime
